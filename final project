{"cells":[{"cell_type":"code","source":["import os\n","import numpy as np\n","import pandas as pd\n","from sklearn.model_selection import train_test_split, RandomizedSearchCV\n","from sklearn.preprocessing import OneHotEncoder, StandardScaler\n","from sklearn.compose import ColumnTransformer\n","from sklearn.pipeline import Pipeline\n","from sklearn.impute import SimpleImputer\n","from sklearn.metrics import classification_report, roc_auc_score, confusion_matrix\n","from sklearn.inspection import permutation_importance\n","import matplotlib.pyplot as plt\n","import joblib\n","import warnings\n","warnings.filterwarnings(\"ignore\")\n","# Optional: compatibility hack for some shap/numpy versions\n","# (uncomment if you hit AttributeError: module 'numpy' has no attribute 'int')\n","# import numpy as _np\n","# if not hasattr(_np, 'int'):\n","#     _np.int = int\n","\n","# Try imports\n","try:\n","    import xgboost as xgb\n","    XGBOOST_AVAILABLE = True\n","except Exception:\n","    XGBOOST_AVAILABLE = False\n","try:\n","    import shap\n","    SHAP_AVAILABLE = True\n","except Exception:\n","    SHAP_AVAILABLE = False\n","\n","def generate_synthetic_loan_data(n=5000, seed=42):\n","    rng = np.random.RandomState(seed)\n","    df = pd.DataFrame()\n","    df['loan_amnt'] = rng.normal(15000, 7000, n).clip(1000, 40000).round(0)\n","    df['term_months'] = rng.choice([36, 60], n, p=[0.7,0.3])\n","    df['int_rate'] = rng.normal(12, 6, n).clip(5,35).round(2)\n","    df['installment'] = (df['loan_amnt'] * (df['int_rate']/1200) /\n","                         (1 - (1 + df['int_rate']/1200) ** (-df['term_months']))).round(2)\n","    df['annual_inc'] = rng.normal(60000, 30000, n).clip(8000,300000).round(0)\n","    df['dti'] = rng.normal(18, 10, n).clip(0,50).round(2)\n","    df['emp_length'] = rng.choice(['< 1 year','1-3 years','3-5 years','5-10 years','10+ years'], n, p=[0.1,0.25,0.3,0.2,0.15])\n","    df['home_ownership'] = rng.choice(['RENT','MORTGAGE','OWN','OTHER'], n, p=[0.45,0.35,0.15,0.05])\n","    df['purpose'] = rng.choice(['debt_consolidation','credit_card','home_improvement','major_purchase','small_business','other'], n)\n","    df['credit_score'] = rng.normal(680, 60, n).clip(300,850).round(0)\n","    df['revol_bal'] = rng.normal(8000, 7000, n).clip(0,80000).round(0)\n","    df['revol_util'] = rng.normal(45,25,n).clip(0,150).round(2)\n","    df['open_acc'] = rng.poisson(6, n).clip(1,40)\n","    df['pub_rec'] = rng.poisson(0.2, n).clip(0,10)\n","    df['total_acc'] = (df['open_acc'] + rng.poisson(4, n)).clip(1,60)\n","    df['delinq_2yrs'] = rng.poisson(0.3, n).clip(0,10)\n","    # Create default probability with a logistic-style formula\n","    logit = (-3.5\n","             + 0.00005*(df['loan_amnt']-15000)\n","             + 0.04*(df['int_rate']-12)\n","             + 0.02*(df['dti']-18)\n","             - 0.006*(df['annual_inc']-60000)/1000\n","             - 0.008*(df['credit_score']-680)\n","             + 0.2*df['pub_rec']\n","             + 0.12*df['delinq_2yrs']\n","             + 0.00002*(df['revol_bal']-8000))\n","    prob = 1/(1 + np.exp(-logit))\n","    df['default'] = (rng.rand(n) < prob).astype(int)\n","    return df\n","\n","def build_and_run_pipeline(df, save_artifacts=True, shap_run=True):\n","    X = df.drop(columns=['default'])\n","    y = df['default']\n","    X_train, X_test, y_train, y_test = train_test_split(X,y,test_size=0.25, random_state=42, stratify=y)\n","    numeric_features = ['loan_amnt','int_rate','installment','annual_inc','dti','credit_score','revol_bal','revol_util','open_acc','pub_rec','total_acc','delinq_2yrs','term_months']\n","    categorical_features = ['emp_length','home_ownership','purpose']\n","    num_pipe = Pipeline([('imputer', SimpleImputer(strategy='median')),('scaler', StandardScaler())])\n","    cat_pipe = Pipeline([('imputer', SimpleImputer(strategy='constant', fill_value='missing')),('onehot', OneHotEncoder(handle_unknown='ignore'))])\n","    preprocessor = ColumnTransformer([('num', num_pipe, numeric_features), ('cat', cat_pipe, categorical_features)])\n","    if XGBOOST_AVAILABLE:\n","        model = xgb.XGBClassifier(objective='binary:logistic', eval_metric='auc', use_label_encoder=False, n_jobs=4, random_state=42, verbosity=0, n_estimators=80)\n","    else:\n","        from sklearn.ensemble import RandomForestClassifier\n","        model = RandomForestClassifier(n_estimators=100, random_state=42, n_jobs=4)\n","    pipeline = Pipeline([('preprocessor', preprocessor), ('model', model)])\n","    # light hyperparam search to keep runtime reasonable\n","    params = {'model__max_depth':[3,4], 'model__n_estimators':[50,80]}\n","    if XGBOOST_AVAILABLE:\n","        params['model__learning_rate'] = [0.05,0.1]\n","    rs = RandomizedSearchCV(pipeline, params, n_iter=2, cv=2, scoring='roc_auc', random_state=42, n_jobs=1)\n","    rs.fit(X_train, y_train)\n","    best = rs.best_estimator_\n","    y_pred = best.predict(X_test)\n","    y_proba = best.predict_proba(X_test)[:,1]\n","    print(\"ROC AUC:\", roc_auc_score(y_test, y_proba))\n","    print(classification_report(y_test, y_pred))\n","    print(\"Confusion matrix:\\n\", confusion_matrix(y_test,y_pred))\n","    # Build feature names robustly\n","    X_test_trans = best.named_steps['preprocessor'].transform(X_test)\n","    n_transformed = X_test_trans.shape[1]\n","    feature_names = []\n","    try:\n","        feature_names.extend(numeric_features)\n","        ohe = best.named_steps['preprocessor'].named_transformers_['cat'].named_steps['onehot']\n","        feature_names.extend(list(ohe.get_feature_names_out(categorical_features)))\n","    except Exception:\n","        feature_names = []\n","    if len(feature_names) != n_transformed:\n","        feature_names = [f\"f_{i}\" for i in range(n_transformed)]\n","    # Permutation importance\n","    perm = permutation_importance(best, X_test, y_test, n_repeats=6, random_state=42, n_jobs=4)\n","    imp_mean = perm.importances_mean\n","    imp_std = perm.importances_std\n","    # align lengths\n","    L = min(len(imp_mean), len(feature_names))\n","    imp_df = pd.DataFrame({'feature': feature_names[:L],\n","                           'importance_mean': imp_mean[:L],\n","                           'importance_std': imp_std[:L]}).sort_values('importance_mean', ascending=False)\n","    print(\"Top permutation importances:\\n\", imp_df.head(10))\n","    # SHAP analysis (guarded)\n","    if shap_run and SHAP_AVAILABLE and XGBOOST_AVAILABLE and isinstance(best.named_steps['model'], xgb.XGBClassifier):\n","        os.makedirs('plots', exist_ok=True)\n","        explainer = shap.TreeExplainer(best.named_steps['model'])\n","        shap_values = explainer.shap_values(X_test_trans)\n","        shap.summary_plot(shap_values, X_test_trans, feature_names=feature_names, show=False)\n","        plt.tight_layout(); plt.savefig('plots/shap_summary.png'); plt.close()\n","        # dependence plots for top 4 features\n","        top_feats = list(imp_df['feature'][:4])\n","        for feat in top_feats:\n","            idx = feature_names.index(feat)\n","            shap.dependence_plot(idx, shap_values, X_test_trans, feature_names=feature_names, show=False)\n","            plt.tight_layout(); plt.savefig(f\"plots/shap_dependence_{feat}.png\"); plt.close()\n","        # local force plots for one TP and one FN (if present)\n","        preds = best.predict(X_test)\n","        y_test_reset = y_test.reset_index(drop=True)\n","        tp_idx = np.where((preds==1) & (y_test_reset==1))[0]\n","        fn_idx = np.where((preds==0) & (y_test_reset==1))[0]\n","        if len(tp_idx)>0:\n","            i = tp_idx[0]\n","            shap.force_plot(explainer.expected_value, shap_values[i], X_test_trans[i], feature_names=feature_names, show=False, matplotlib=True)\n","            plt.tight_layout(); plt.savefig(\"plots/shap_force_true_positive.png\"); plt.close()\n","        if len(fn_idx)>0:\n","            i = fn_idx[0]\n","            shap.force_plot(explainer.expected_value, shap_values[i], X_test_trans[i], feature_names=feature_names, show=False, matplotlib=True)\n","            plt.tight_layout(); plt.savefig(\"plots/shap_force_false_negative.png\"); plt.close()\n","        print(\"Saved SHAP plots under ./plots\")\n","    else:\n","        print(\"SHAP not run (either not installed or model not XGBoost).\")\n","    # Save artifacts\n","    if save_artifacts:\n","        os.makedirs('artifacts', exist_ok=True)\n","        joblib.dump(best, 'artifacts/best_pipeline.joblib')\n","        imp_df.to_csv('artifacts/feature_importances.csv', index=False)\n","    return best, imp_df\n","\n","if __name__ == \"__main__\":\n","    df = generate_synthetic_loan_data(n=5000)\n","    model, imp = build_and_run_pipeline(df, save_artifacts=True, shap_run=True)\n","    print(\"Run complete. Check ./artifacts and ./plots (if shap ran).\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"LnFc75n_16TR","executionInfo":{"status":"ok","timestamp":1763535850693,"user_tz":-330,"elapsed":10715,"user":{"displayName":"Vidhya Nehruji","userId":"11659698494481430093"}},"outputId":"f9703165-6d1f-49dd-eb26-a060500d918b"},"execution_count":4,"outputs":[{"output_type":"stream","name":"stdout","text":["ROC AUC: 0.69500485302274\n","              precision    recall  f1-score   support\n","\n","           0       0.96      1.00      0.98      1202\n","           1       0.00      0.00      0.00        48\n","\n","    accuracy                           0.96      1250\n","   macro avg       0.48      0.50      0.49      1250\n","weighted avg       0.92      0.96      0.94      1250\n","\n","Confusion matrix:\n"," [[1202    0]\n"," [  48    0]]\n","Top permutation importances:\n","         feature  importance_mean  importance_std\n","0     loan_amnt              0.0             0.0\n","1      int_rate              0.0             0.0\n","2   installment              0.0             0.0\n","3    annual_inc              0.0             0.0\n","4           dti              0.0             0.0\n","5  credit_score              0.0             0.0\n","6     revol_bal              0.0             0.0\n","7    revol_util              0.0             0.0\n","8      open_acc              0.0             0.0\n","9       pub_rec              0.0             0.0\n","Saved SHAP plots under ./plots\n","Run complete. Check ./artifacts and ./plots (if shap ran).\n"]}]}],"metadata":{"colab":{"provenance":[{"file_id":"/v2/external/notebooks/intro.ipynb","timestamp":1763534353569}]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}